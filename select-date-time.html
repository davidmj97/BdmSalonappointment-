<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Date & Time – BDM Salon</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      --border-color: #444;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 120px;
    }
    .header-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #000;
      z-index: 100;
      padding: 10px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .step-heading {
      text-align: center;
      margin: 10px 0;
      font-size: 20px;
      color: white;
    }
    .btn-container {
      display: flex;
      gap: 16px;
      margin: 0 16px 10px;
      padding: 0;
    }
    .btn-prev,
    .next-btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-prev {
      background: #444;
      color: #fff;
    }
    .next-btn {
      background: var(--accent);
      color: white;
    }
    .btn-prev:disabled,
    .next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .container {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    .cards-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      padding: 0 8px;
    }
    .date-card {
      background: #111;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
    }
    .date-card.unavailable {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .date-day {
      font-size: 14px;
      color: #ccc;
      margin-bottom: 6px;
    }
    .date-number {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .date-month {
      font-size: 14px;
      color: #aaa;
    }
    .date-card.selected {
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      color: white;
    }
    .time-card {
      background: #222;
      border-radius: 10px;
      padding: 16px 14px;
      min-width: 140px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      color: #fff;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 500;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      position: relative;
    }
    .time-card.selected {
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      border-color: #90caf9;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .time-card.unavailable {
      background: #444;
      color: #777;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .time-card::after {
      content: '';
      position: absolute;
      top: 5px;
      right: 5px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }
    .time-card.unavailable::after {
      background: #f44336;
    }
    .time-card:hover:not(.unavailable) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .month-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 10px;
    }
    .month-title {
      font-size: 18px;
      font-weight: 600;
      color: #90caf9;
      min-width: 200px;
      text-align: center;
    }
    .nav-arrow {
      background: #222;
      color: #fff;
      border: none;
      font-size: 24px;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      transition: background 0.15s;
    }
    .nav-arrow:hover {
      background: #1a237e;
    }
    #datesGrid,
    #timesGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .loading {
      text-align: center;
      color: #90caf9;
      padding: 20px;
      font-style: italic;
    }
    .no-slots {
      grid-column: 1 / -1;
      text-align: center;
      color: #aaa;
      padding: 20px;
      font-style: italic;
    }
    @media (max-width: 900px) {
      body {
        padding-top: 110px;
      }
      .date-card {
        padding: 16px;
        min-width: 80px;
      }
      .date-number {
        font-size: 24px;
      }
      .time-card {
        padding: 12px;
        min-width: 120px;
      }
    }
    ::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <h1 class="step-heading">Step 3: Select Date & Time</h1>
    <div class="btn-container">
      <button class="btn-prev" onclick="window.history.back()">Back</button>
      <button class="next-btn" id="nextBtn" disabled>Next</button>
    </div>
  </div>
  <div class="container">
    <div class="cards-container">
      <div>
        <div class="month-header">
          <button class="nav-arrow" id="prevMonthBtn">‹</button>
          <div class="month-title" id="currentMonth">Loading...</div>
          <button class="nav-arrow" id="nextMonthBtn">›</button>
        </div>
        <div class="cards-grid" id="datesGrid">
          <div class="loading">Loading available dates...</div>
        </div>
      </div>
      <div id="timeSelectionSection">
        <div class="section-title">Select Time</div>
        <div class="cards-grid" id="timesGrid"></div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmimDsjW_pF2NGw-w-40QzTsgmf1tdqyI",
      authDomain: "bdmsalonappointment.firebaseapp.com",
      databaseURL: "https://bdmsalonappointment-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bdmsalonappointment",
      storageBucket: "bdmsalonappointment.firebasestorage.app",
      messagingSenderId: "123933913893",
      appId: "1:123933913893:web:c1f57caf4dc2a5440ba0cc",
      measurementId: "G-Q0FVZRVS64"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM elements
    const datesGrid = document.getElementById('datesGrid');
    const timesGrid = document.getElementById('timesGrid');
    const nextBtn = document.getElementById('nextBtn');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const currentMonthEl = document.getElementById('currentMonth');
    const timeSection = document.getElementById('timeSelectionSection');

    // State
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let availableSlots = {};

    // Load available slots from Firebase
    function loadAvailableSlots() {
      datesGrid.innerHTML = '<div class="loading">Loading available dates...</div>';
      timesGrid.innerHTML = '';

      database.ref('availableSlots').on('value', (snapshot) => {
        availableSlots = snapshot.val() || {};
        renderDates();
        if (selectedDate) {
          renderTimes();
        }
      });
    }

    // Render available dates
    function renderDates() {
      datesGrid.innerHTML = '';
      const today = new Date();
      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const monthStart = firstDayOfMonth.getDay();
      
      // Get dates with available slots
      const availableDates = Object.keys(availableSlots || {}).filter(date => {
        const slots = availableSlots[date];
        return slots && Object.keys(slots).length > 0;
      });

      // Add month header
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      currentMonthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      // Add day headers
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'date-day';
        dayHeader.textContent = day;
        dayHeader.style.textAlign = 'center';
        dayHeader.style.padding = '10px';
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.color = '#90caf9';
        datesGrid.appendChild(dayHeader);
      });

      // Add empty cells for days before the first of the month
      for (let i = 0; i < monthStart; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.visibility = 'hidden';
        datesGrid.appendChild(emptyCell);
      }

      // Add date cells
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(currentYear, currentMonth, d);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const isoStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

        // Check if this date has any available slots
        const hasAvailableSlots = availableDates.includes(isoStr);
        const isPastDate = date < today && date.toDateString() !== today.toDateString();
        const isSelectable = hasAvailableSlots && !isPastDate;

        const dateCard = document.createElement('div');
        dateCard.className = 'date-card';
        if (!isSelectable) {
          dateCard.classList.add('unavailable');
        }
        dateCard.dataset.date = isoStr;

        const dayName = dayNames[date.getDay()];
        const monthName = monthNames[month - 1].substring(0, 3);
        
        dateCard.innerHTML = `
          <div class="date-day">${dayName}</div>
          <div class="date-number">${day}</div>
          <div class="date-month">${monthName}</div>
        `;

        if (selectedDate === isoStr) {
          dateCard.classList.add('selected');
        }

        if (isSelectable) {
          dateCard.addEventListener('click', () => {
            document.querySelectorAll('.date-card.selected').forEach(el => el.classList.remove('selected'));
            dateCard.classList.add('selected');
            selectedDate = isoStr;
            selectedTime = null;
            renderTimes();
            updateNextButton();
            setTimeout(() => {
              timeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
          });
        }

        datesGrid.appendChild(dateCard);
      }

      // Show message if no dates available
      if (availableDates.length === 0) {
        datesGrid.innerHTML = '<div class="no-slots">No available dates found. Please check back later.</div>';
      }
    }

    // Render available times for selected date
    function renderTimes() {
      timesGrid.innerHTML = '';
      if (!selectedDate) {
        timesGrid.innerHTML = '<div class="no-slots">Please select a date first</div>';
        return;
      }

      const dateSlots = availableSlots[selectedDate] || {};
      const slots = Object.values(dateSlots);

      if (slots.length === 0) {
        timesGrid.innerHTML = '<div class="no-slots">No time slots available for this date</div>';
        return;
      }

      // Sort slots by start time
      slots.sort((a, b) => a.startTime.localeCompare(b.startTime));

      // Render each time slot
      slots.forEach((slot, index) => {
        const timeCard = document.createElement('div');
        timeCard.className = 'time-card';
        
        const startTime = slot.startTime;
        const endTime = slot.endTime;
        const displayTime = `${startTime} - ${endTime}`;
        
        timeCard.textContent = displayTime;
        timeCard.dataset.start = startTime;
        timeCard.dataset.end = endTime;
        timeCard.dataset.max = slot.maxBookings || 1;
        timeCard.dataset.index = index;

        // Check if slot is fully booked
        const currentBookings = slot.currentBookings || 0;
        const maxBookings = slot.maxBookings || 1;
        const isFullyBooked = currentBookings >= maxBookings;
        
        if (isFullyBooked) {
          timeCard.classList.add('unavailable');
          timeCard.title = 'This time slot is fully booked';
        } else {
          const isSelected = selectedTime === `${startTime}-${endTime}`;
          if (isSelected) {
            timeCard.classList.add('selected');
          }
          timeCard.addEventListener('click', () => {
            document.querySelectorAll('.time-card.selected').forEach(el => el.classList.remove('selected'));
            timeCard.classList.add('selected');
            selectedTime = `${startTime}-${endTime}`;
            updateNextButton();
          });
        }

        timesGrid.appendChild(timeCard);
      });
    }

    // Update next button state
    function updateNextButton() {
      nextBtn.disabled = !(selectedDate && selectedTime);
    }

    // Event listeners
    prevMonthBtn.addEventListener('click', () => {
      if (currentMonth === 0) {
        currentMonth = 11;
        currentYear--;
      } else {
        currentMonth--;
      }
      renderDates();
    });

    nextMonthBtn.addEventListener('click', () => {
      if (currentMonth === 11) {
        currentMonth = 0;
        currentYear++;
      } else {
        currentMonth++;
      }
      renderDates();
    });

    nextBtn.addEventListener('click', () => {
      if (!selectedDate || !selectedTime) return;
      
      // Store selected date and time in localStorage
      localStorage.setItem('selectedDate', selectedDate);
      localStorage.setItem('selectedTime', selectedTime);
      
      // Store the full time slot details
      const [startTime, endTime] = selectedTime.split('-');
      localStorage.setItem('selectedTimeSlot', JSON.stringify({
        startTime,
        endTime,
        date: selectedDate
      }));

      // Format and store the display date
      const dateParts = selectedDate.split('-');
      const year = parseInt(dateParts[0], 10);
      const month = parseInt(dateParts[1], 10);
      const day = parseInt(dateParts[2], 10);
      
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      
      const date = new Date(year, month - 1, day);
      const weekdayNames = [
        "Sunday", "Monday", "Tuesday", "Wednesday",
        "Thursday", "Friday", "Saturday"
      ];
      
      const weekdayIndex = date.getDay();
      const formattedDate = `${weekdayNames[weekdayIndex]}, ${monthNames[month-1]} ${day}, ${year}`;
      localStorage.setItem('formattedDate', formattedDate);

      // Go to details page
      window.location.href = 'add-details.html';
    });

    // Initialize the page
    function init() {
      loadAvailableSlots();
      updateNextButton();
      
      // Set initial month display
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      currentMonthEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
