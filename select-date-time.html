<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Date & Time – BDM Salon</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      --border-color: #444;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 120px;
    }
    .header-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #000;
      z-index: 100;
      padding: 10px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .step-heading {
      text-align: center;
      margin: 10px 0;
      font-size: 20px;
      color: white;
    }
    .btn-container {
      display: flex;
      gap: 16px;
      margin: 0 16px 10px;
      padding: 0;
    }
    .btn-prev,
    .next-btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-prev {
      background: #444;
      color: #fff;
    }
    .next-btn {
      background: var(--accent);
      color: white;
    }
    .btn-prev:disabled,
    .next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .container {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    .cards-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      padding: 0 8px;
    }
    .date-card {
      background: #111;
      border-radius: 10px;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 70px;
      margin: 4px;
      opacity: 0.7;
    }
    .date-card.selected {
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      color: white;
      opacity: 1;
    }
    .date-card:not(.unavailable):not(.no-slots) {
      opacity: 1;
      border: 2px solid #4caf50;
    }
    .date-card.no-slots {
      position: relative;
    }
    .date-card.no-slots::after {
      content: '';
      position: absolute;
      top: 5px;
      right: 5px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #ff9800;
    }
    .date-card.unavailable {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .date-number {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    .date-month {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .date-day {
      font-size: 12px;
      color: #aaa;
      margin-top: 2px;
    }
    .time-card {
      background: #222;
      border-radius: 8px;
      padding: 14px 16px 14px 40px;
      min-width: 140px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      color: #fff;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 500;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      position: relative;
    }
    .time-card.selected {
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      border-color: #90caf9;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .time-card.unavailable {
      background: #222;
      color: #777;
      cursor: not-allowed;
    }
    .time-card::before {
      content: '';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4caf50;
    }
    .time-card.unavailable::before {
      background: #f44336;
    }
    .time-card .booking-count {
      font-size: 12px;
      color: #aaa;
      margin-left: 8px;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 10px;
    }
    .time-card.unavailable .booking-count {
      color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
    .time-card.selected .booking-count {
      color: #fff;
      background: rgba(255, 255, 255, 0.2);
    }
    .time-card:hover:not(.unavailable) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .month-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 10px;
    }
    .month-title {
      font-size: 18px;
      font-weight: 600;
      color: #90caf9;
      min-width: 200px;
      text-align: center;
    }
    .nav-arrow {
      background: #222;
      color: #fff;
      border: none;
      font-size: 24px;
      cursor: pointer;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      line-height: 36px;
      text-align: center;
      transition: background 0.15s;
    }
    .nav-arrow:hover {
      background: #1a237e;
    }
    #datesGrid,
    #timesGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .loading {
      text-align: center;
      color: #90caf9;
      padding: 20px;
      font-style: italic;
      grid-column: 1 / -1;
    }
    .no-slots {
      grid-column: 1 / -1;
      text-align: center;
      color: #aaa;
      padding: 20px;
      font-style: italic;
    }
    @media (max-width: 900px) {
      body {
        padding-top: 110px;
      }
      .date-card {
        padding: 10px 6px;
        min-width: 60px;
      }
      .date-number {
        font-size: 18px;
      }
      .time-card {
        padding: 12px 16px 12px 36px;
        min-width: 120px;
        font-size: 14px;
      }
      .time-card::before {
        left: 14px;
      }
    }
    @media (max-width: 400px) {
      .time-card {
        width: 100%;
        max-width: 160px;
      }
    }
    ::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <h1 class="step-heading">Step 3: Select Date & Time</h1>
    <div class="btn-container">
      <button class="btn-prev" onclick="window.history.back()">Back</button>
      <button class="next-btn" id="nextBtn" disabled>Next</button>
    </div>
  </div>
  <div class="container">
    <div class="cards-container">
      <div>
        <div class="month-header">
          <button class="nav-arrow" id="prevMonthBtn">‹</button>
          <div class="month-title" id="currentMonth">Loading...</div>
          <button class="nav-arrow" id="nextMonthBtn">›</button>
        </div>
        <div class="cards-grid" id="datesGrid">
          <div class="loading">Loading available dates...</div>
        </div>
      </div>
      <div id="timeSelectionSection">
        <div class="section-title">Select Time</div>
        <div class="cards-grid" id="timesGrid"></div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmimDsjW_pF2NGw-w-40QzTsgmf1tdqyI",
      authDomain: "bdmsalonappointment.firebaseapp.com",
      databaseURL: "https://bdmsalonappointment-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bdmsalonappointment",
      storageBucket: "bdmsalonappointment.firebasestorage.app",
      messagingSenderId: "123933913893",
      appId: "1:123933913893:web:c1f57caf4dc2a5440ba0cc",
      measurementId: "G-Q0FVZRVS64"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // DOM elements
    const datesGrid = document.getElementById('datesGrid');
    const timesGrid = document.getElementById('timesGrid');
    const nextBtn = document.getElementById('nextBtn');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const currentMonthEl = document.getElementById('currentMonth');
    const timeSection = document.getElementById('timeSelectionSection');

    // State
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let availableSlots = {};

    // Load available slots from Firebase
    function loadAvailableSlots() {
      datesGrid.innerHTML = '<div class="loading">Loading available dates...</div>';
      timesGrid.innerHTML = '';

      database.ref('availableSlots').on('value', (snapshot) => {
        availableSlots = snapshot.val() || {};
        renderDates();
        if (selectedDate) {
          renderTimes();
        }
      }, (error) => {
        console.error('Error loading slots:', error);
        datesGrid.innerHTML = '<div class="no-slots">Error loading dates. Please try again.</div>';
      });
    }

    // Format time to 12-hour format
    function formatTime(time24) {
      const [hours, minutes] = time24.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    // Get end time (30 minutes after start)
    function getEndTime(startTime) {
      const [hours, minutes] = startTime.split(':').map(Number);
      let endHours = hours;
      let endMinutes = minutes + 30;
      
      if (endMinutes >= 60) {
        endHours += Math.floor(endMinutes / 60);
        endMinutes %= 60;
      }
      
      return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
    }

    // Render available dates
    function renderDates() {
      datesGrid.innerHTML = '';
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time part to compare dates only
      
      // Show dates for next 60 days
      for (let i = 0; i < 60; i++) {
        const date = new Date();
        date.setDate(today.getDate() + i);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const monthName = date.toLocaleDateString('en-US', { month: 'short' });

        const dateCard = document.createElement('div');
        dateCard.className = 'date-card';
        dateCard.dataset.date = dateStr;

        // Check if this date has available slots
        const hasSlots = availableSlots[dateStr] && Object.keys(availableSlots[dateStr]).length > 0;
        const isPastDate = date < today;
        
        if (isPastDate) {
          dateCard.classList.add('unavailable');
        } else if (!hasSlots) {
          dateCard.classList.add('no-slots');
        }

        dateCard.innerHTML = `
          <div class="date-number">${date.getDate()}</div>
          <div class="date-month">${monthName}</div>
          <div class="date-day">${dayName}</div>
        `;

        if (!isPastDate) {
          dateCard.addEventListener('click', () => {
            document.querySelectorAll('.date-card.selected').forEach(el => el.classList.remove('selected'));
            dateCard.classList.add('selected');
            selectedDate = dateStr;
            selectedTime = null;
            renderTimes();
            updateNextButton();
          });
        }

        datesGrid.appendChild(dateCard);
      }

      // Auto-select today if not already selected
      if (!selectedDate) {
        const todayStr = today.toISOString().split('T')[0];
        selectedDate = todayStr;
        const todayCard = document.querySelector(`.date-card[data-date="${todayStr}"]`);
        if (todayCard) {
          todayCard.classList.add('selected');
          renderTimes();
        }
      }
    }

    // Render available times for selected date
    function renderTimes() {
      timesGrid.innerHTML = '';
      if (!selectedDate) {
        timesGrid.innerHTML = '<div class="no-slots">Please select a date first</div>';
        return;
      }

      const dateSlots = availableSlots[selectedDate] || {};
      const slots = Object.values(dateSlots);

      if (slots.length === 0) {
        timesGrid.innerHTML = `
          <div class="no-slots">
            No time slots available for this date.<br>
            Please select another date or check back later.
          </div>
        `;
        return;
      }

      // Generate time slots from 9:00 AM to 6:00 PM in 30-minute intervals
      const timeSlots = [];
      for (let hour = 9; hour < 18; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
          const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          const formattedTime = formatTime(time);
          timeSlots.push({
            display: formattedTime,
            time: time,
            endTime: getEndTime(time)
          });
        }
      }

      // Add 6:00 PM slot
      timeSlots.push({
        display: '06:00 PM',
        time: '18:00',
        endTime: '18:30'
      });

      // Render each time slot
      timeSlots.forEach(slot => {
        const timeCard = document.createElement('div');
        timeCard.className = 'time-card';
        
        // Check if this slot exists in the available slots
        const slotKey = `${slot.time}-${slot.endTime}`;
        const availableSlot = Object.values(slots).find(s => 
          s.startTime === slot.time && s.endTime === slot.endTime
        );

        // Create time text
        const timeText = document.createElement('span');
        timeText.textContent = slot.display;
        
        // Add elements to time card
        timeCard.appendChild(timeText);
        
        if (availableSlot) {
          const currentBookings = parseInt(availableSlot.currentBookings || 0);
          const maxBookings = parseInt(availableSlot.maxBookings || 1);
          const isAvailable = currentBookings < maxBookings;

          // Only show booking count if there are current bookings
          if (maxBookings > 1 && currentBookings > 0) {
            const countSpan = document.createElement('span');
            countSpan.className = 'booking-count';
            countSpan.textContent = `${currentBookings}/${maxBookings}`;
            timeCard.appendChild(countSpan);
          }

          if (isAvailable) {
            timeCard.addEventListener('click', () => {
              document.querySelectorAll('.time-card.selected').forEach(el => el.classList.remove('selected'));
              timeCard.classList.add('selected');
              selectedTime = `${slot.time}-${slot.endTime}`;
              // Store the slot ID for the booking confirmation
              localStorage.setItem('selectedSlotId', availableSlot.id || `${slot.time}-${slot.endTime}`);
              localStorage.setItem('selectedDate', selectedDate);
              updateNextButton();
            });
          } else {
            timeCard.classList.add('unavailable');
            timeCard.title = 'This time slot is fully booked';
          }
        } else {
          timeCard.classList.add('unavailable');
          timeCard.title = 'This time slot is not available';
        }

        timesGrid.appendChild(timeCard);
      });

      // If no slots are available, show message
      const availableSlotsCount = document.querySelectorAll('.time-card:not(.unavailable)').length;
      if (availableSlotsCount === 0) {
        timesGrid.innerHTML = '<div class="no-slots">No available time slots for this date</div>';
      }
    }

    // Update next button state
    function updateNextButton() {
      nextBtn.disabled = !(selectedDate && selectedTime);
    }

    // Event listeners
    prevMonthBtn.addEventListener('click', () => {
      if (currentMonth === 0) {
        currentMonth = 11;
        currentYear--;
      } else {
        currentMonth--;
      }
      renderDates();
    });

    nextMonthBtn.addEventListener('click', () => {
      if (currentMonth === 11) {
        currentMonth = 0;
        currentYear++;
      } else {
        currentMonth++;
      }
      renderDates();
    });

    nextBtn.addEventListener('click', () => {
      if (!selectedDate || !selectedTime) return;
      
      // Store selected date and time in localStorage
      localStorage.setItem('selectedDate', selectedDate);
      localStorage.setItem('selectedTime', selectedTime);
      
      // Store the full time slot details
      const [startTime, endTime] = selectedTime.split('-');
      localStorage.setItem('selectedTimeSlot', JSON.stringify({
        startTime,
        endTime,
        date: selectedDate
      }));

      // Format and store the display date
      const dateParts = selectedDate.split('-');
      const year = parseInt(dateParts[0], 10);
      const month = parseInt(dateParts[1], 10);
      const day = parseInt(dateParts[2], 10);
      
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      
      const date = new Date(year, month - 1, day);
      const weekdayNames = [
        "Sunday", "Monday", "Tuesday", "Wednesday",
        "Thursday", "Friday", "Saturday"
      ];
      
      const weekdayIndex = date.getDay();
      const formattedDate = `${weekdayNames[weekdayIndex]}, ${monthNames[month-1]} ${day}, ${year}`;
      localStorage.setItem('formattedDate', formattedDate);

      // Go to details page
      window.location.href = 'add-details.html';
    });

    // Initialize the page
    function init() {
      loadAvailableSlots();
      updateNextButton();
      
      // Set initial month display
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      currentMonthEl.textContent = `${monthNames[new Date().getMonth()]} ${new Date().getFullYear()}`;
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
